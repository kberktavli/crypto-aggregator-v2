<!DOCTYPE html>
<html>
<head>
    <title>V2 FINAL TEST</title>
    <script src="https://unpkg.com/centrifuge@5.0.1/dist/centrifuge.js"></script>
    <style>
        body { background-color: #1a1a1a; color: #00ff00; font-family: 'Courier New', monospace; padding: 20px; }
        #price-box { font-size: 80px; font-weight: bold; color: yellow; margin: 20px 0; }
        .log-entry { border-bottom: 1px solid #333; padding: 5px; }
        .error { color: red; }
        .success { color: #00ff00; }
    </style>
</head>
<body>
    <h1>ðŸ¦… V2 TRADING BOT - CANLI Ä°ZLEME</h1>
    <h3 id="status" style="color:orange">BaÄŸlanÄ±yor...</h3>
    
    <div id="price-box">---</div>

    <h3>ðŸ“¡ Gelen Sinyaller & Loglar:</h3>
    <div id="logs"></div>

    <script>
        const logDiv = document.getElementById('logs');
        const priceBox = document.getElementById('price-box');
        const status = document.getElementById('status');

        function addLog(msg, type = 'normal') {
            const div = document.createElement('div');
            div.className = `log-entry ${type}`;
            div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logDiv.prepend(div);
        }

        // 1. BAÄžLANTI ADRESÄ° (DÄ°KKAT: Port 3000)
        // GoFiber endpointimiz: /connection/websocket
        // ðŸ‘‡ PORTU 8085 YAPTIK ve YOLU EKLEDÄ°K:
const cent = new Centrifuge('ws://localhost:8085/connection/websocket', {
    debug: true
});

        cent.on('connected', (ctx) => {
            status.innerText = "ðŸŸ¢ BAÄžLANDI (Client ID: " + ctx.client + ")";
            status.style.color = "#00ff00";
            addLog("âœ… Sunucuya baÅŸarÄ±yla baÄŸlanÄ±ldÄ±.", "success");
        });

        cent.on('disconnected', (ctx) => {
            status.innerText = "ðŸ”´ KOPTU: " + ctx.reason;
            status.style.color = "red";
            addLog("âŒ BaÄŸlantÄ± koptu: " + ctx.reason, "error");
        });

        cent.on('error', (ctx) => {
            addLog("âš ï¸ Genel Hata: " + JSON.stringify(ctx), "error");
        });

        // 2. ABONELÄ°K (DÄ°KKAT: Kanal adÄ± sadece 'kline')
        const sub = cent.newSubscription('kline');

        sub.on('publication', (ctx) => {
            // Gelen veri JSON formatÄ±nda: {Open:..., Close:..., ...}
            const data = ctx.data;
            addLog(`ðŸš€ VERÄ° GELDÄ°: ${JSON.stringify(data)}`);
            
            // FiyatÄ± ekrana bas
            if (data.close) {
                priceBox.innerText = "$" + parseFloat(data.close).toFixed(2);
            } else if (data.Close) { // BÃ¼yÃ¼k harf gelirse diye
                priceBox.innerText = "$" + parseFloat(data.Close).toFixed(2);
            }
        });

        sub.on('subscribed', () => {
            addLog("ðŸ“¡ 'kline' kanalÄ±na abone olundu!", "success");
        });

        sub.on('error', (err) => {
            addLog("â›” Abonelik HatasÄ±: " + JSON.stringify(err), "error");
        });

        sub.subscribe();
        cent.connect();
    </script>
</body>
</html>